#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path("include/unicode-emoji-4.0.4/lib", __dir__)
$LOAD_PATH.unshift File.expand_path("include/unicode-display_width-3.1.5/lib", __dir__)

require 'unicode/display_width'

def vwidth(str)
    Unicode::DisplayWidth.of(str.to_s, emoji: true, ambwidth: 1)
end

def sanitize_emoji(str)
    # Remove all characters with a width <= 0 from the string
    str.each_grapheme_cluster.select { |g| vwidth(g) > 0 }.join
end

def assert_equal(expected, actual, message = nil)
    if expected != actual
        raise "Assertion failed#{": #{message}" if message}\nExpected: #{expected.inspect}\nActual:   #{actual.inspect}"
    end
end

# Taken from the scrims leaderboard page with
# Array.from(document.getElementsByClassName("emoji")).map(e => e.textContent)
emojis_in_use = ["ðŸ§ ", "ðŸ£", "ðŸ‘¾", "ðŸœ", "ðŸ¡", "ðŸ", "ðŸ¤˜", "ðŸ", "ðŸª", "ðŸ¥·", "ðŸ¦¥", "ðŸ¤º", "ðŸ¤–", "ðŸ‹", "ðŸ¦€", "ðŸ‘½", "ðŸ¦", "ðŸ¥µ", "ðŸš¯", "ðŸ˜Ž", "ðŸƒ", "â›ˆ", "ðŸ™ˆ", "â›", "ðŸª²", "ðŸ¦", "ðŸ’€", "ðŸƒ", "âšœï¸", "ðŸ¦„", "ðŸ¦‹", "ðŸ¦˜", "ðŸ‘‘", "ðŸ¤º", "ðŸ¦™", "â­", "ðŸŒš", "ðŸ¦‰", "ðŸ¹", "ðŸ‘", "ðŸ®", "ðŸ", "ðŸ»ï¸", "ðŸ™", "ðŸ¥•", "âš¡", "ðŸ“", "ðŸ‘¿", "ðŸ’°", "ðŸ§ ", "ðŸŽ…", "", "ðŸ¦¥", "ðŸš€", "ðŸ¦–", "ðŸš¶", "ðŸŠ", "ðŸ‰", "ðŸŸ", "ðŸŽ²", "ðŸ‘º", "ðŸª”", "ðŸ›°ï¸", "ðŸ•", "ðŸ¦‹", "ðŸ£", "ðŸ", "ðŸ", "ðŸ¤–", "ðŸ•Šï¸", "ðŸ§", "ðŸ§", "ðŸ¦€", "ðŸº", "ðŸ¤–", "ðŸ¦—", "ðŸ²", "ðŸ—¿", "ðŸ¤“", "ðŸ‘€", "ðŸ‹ï¸â€â™‚ï¸", "ðŸ", "ðŸ“‰", "âŠš", "ðŸ¦€", "ðŸ˜‡", "ðŸ§¿", "ðŸ’Ž", "ðŸŸ ", "ðŸ§š", "ðŸ’¥", "ðŸ–", "ðŸ•", "ðŸ", "ðŸ»", "ðŸ•", "ðŸ‘‘", "ðŸ¹", "ðŸ‘€", "ðŸ‘»", "ðŸ¨", "ðŸ‘½", "ðŸ¥¸", "ðŸŒŸ", "ðŸ¤–", "ðŸ“ž", "ðŸ¦", "ðŸ’", "ðŸ¦„", "ðŸ›¡ï¸", "ðŸ¦Ž", "ðŸ’¥", "ðŸ‘½", "â¬›", "ðŸ¤¹", "â˜€", "ðŸ¤”", "ðŸ˜®", "ðŸ¤–", "ðŸ’¥", "ðŸŽ¯", "ðŸ¦«", "ðŸŽƒ", "ðŸ¥ž", "ðŸš´", "ðŸˆ", "ðŸŒƒ", "ðŸ€", "ðŸ§­", "â˜£", "ðŸ§Ÿ", "ðŸ¦…", "ðŸ•", "ðŸ—", "ðŸ¤ ", "â˜ƒï¸", "ðŸ”", "ðŸ˜", "ðŸª", "Î£", "ðŸˆ", "ðŸ«•", "ðŸ•µï¸â€â™‚ï¸", "ðŸ£", "ðŸ‘»", "ðŸ›¼", "ðŸ«³", "ðŸŽƒ", "ð–¦¹", "ðŸ˜Ž", "ðŸ¤£", "ðŸµ", "â›„", "ðŸ”®", "ðŸ", "ðŸˆâ€", "ðŸ™", "ðŸ¤”", "â›ï¸", "ðŸŠ", "ðŸ¦€", "ðŸ¶", "â›", "ðŸ¦", "ðŸ·", "ðŸ", "ðŸŒŠ", "ðŸ•µï¸", "ðŸ‘’", "ðŸ¦Ž", "ðŸº", "ðŸ­", "ðŸ’¾", "ðŸŒŒ", "ðŸ¥¶", "ðŸ§­", "ðŸ›¸", "ðŸ±", "ðŸ›°ï¸", "ðŸ‘€", "ðŸ§¸", "ðŸ¤–", "ðŸ”", "ðŸ¦…", "ðŸ¤º", "ðŸ„", "ðŸŒ", "ðŸ’", "ðŸ", "ðŸ¥±", "ðŸ‘€", "ðŸ”¥", "ðŸ¦", "ðŸ“¦", "ðŸ‘", "ðŸ¦†", "ðŸ¦Š", "ðŸ›’", "ðŸ•µï¸", "ðŸ—¿", "ðŸˆ", "ðŸ¥­", "ðŸ—¿", "ðŸ¦–", "ðŸ¤–", "ðŸ¤–", "ðŸŽ®", "ðŸ—¿", "ðŸ›©ï¸", "ðŸ¥·", "ðŸ¤‘", "ðŸ¤‘", "ðŸ“ƒ", "ðŸ’€", "ðŸ‘¾", "ðŸ", "ðŸ¦‹", "ðŸœ", "âˆ°", "â›„ï¸", "ðŸ°", "ðŸ¦Š", "ðŸŽ¶", "ðŸ¤–", "ðŸ•¸", "âš¡", "ðŸ—¿", "ðŸ¤–", "ðŸ§", "ðŸ”¥", "â›µ", "ðŸ’€", "ðŸ¥‡", "ðŸª±", "ðŸ’°", "=>", "ðŸ”¥", "ðŸ¥¶", "Ni", "ðŸ’€", "ðŸš£", "ðŸ›", "â˜ ï¸", "ðŸ”", "ðŸŽï¸", "ðŸ¤–", "ðŸ›¸", "ðŸ’¥", "ðŸŒŸï¸Ž", "ðŸ¤–", "ðŸ—¿", "â³", "â³", "â³", "â³", "ðŸ¤ ", "ðŸ¦€", "ðŸ’Ž", "ðŸ¥", "ðŸ¥", "ðŸ¥", "ðŸ¥", "ðŸ¥", "ðŸ¥", "ðŸ¥", "ðŸ‘Œ", "ðŸ˜Ž", "ðŸ¤¾", "ðŸ¥¶", "ðŸ¢", "ðŸ¦¢", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ¦€", "ðŸ›¸", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ", "ðŸ”»", "ðŸ¥", "ðŸ¹", "ðŸ¹", "ðŸ¹", "ðŸ™", "ðŸ’¥", "ðŸ’¥", "ðŸ’¥", "ðŸŒˆ", "â˜€ï¸", "ðŸŒ™", "â˜•", "â˜•", "ðŸ§ƒ", "ðŸŽƒ", "ðŸ‘¶", "â˜•", "ðŸ•·ï¸", "ðŸ¤–", "ðŸš€", "â˜•", "â˜•", "ðŸ—¿", "ðŸ§µ", "â˜•", "ðŸ¤–", "ðŸ¤–", "ðŸ¤–", "ðŸ¤–", "ðŸ¤–", "ðŸ§Œ", "ðŸ«ƒ", "ðŸ¦–", "ðŸŒ¿", "ðŸ¶", "ðŸª", "ðŸ’¥", "ðŸ¥", "â„ï¸", "ðŸ—¿", "ðŸ¬", "ðŸ¦…", "ðŸŽ", "ðŸ”¥", "ðŸ¤–", "ðŸ¤–", "ðŸª", "ðŸ¦Š", "ðŸ§›", "â›ï¸", "ðŸ¦€"]
emojis_in_use = emojis_in_use.uniq

emojis_in_use.each_with_index do |emoji, index|
    sanitized = sanitize_emoji(emoji)
    width = vwidth(sanitized)
    assert_equal(sanitized, emoji, "Emoji at index #{index} was altered by sanitize_emoji")
    if width > 2
        raise "Emoji at index #{index} is too wide: '#{emoji}' has width #{width}, expected at most 2"
    end
end
puts "All #{emojis_in_use.length} currently used emojis are still valid and unchanged."

evil_emojis = ["\b\bðŸ‘¿ðŸ‘¿", "\nðŸ‘»", "\rðŸ‘º"]

evil_emojis.each_with_index do |emoji, index|
    sanitized = sanitize_emoji(emoji)
    puts "Evil Emoji #{index}: original width #{vwidth(emoji)}, sanitized width #{vwidth(sanitized)}.\nOriginal:  #{emoji.inspect}\nSanitized: #{sanitized.inspect}\n"
end
